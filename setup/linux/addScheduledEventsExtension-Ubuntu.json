{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "vmName": {
        "type": "string"
      },
      "location": {
        "type": "string"
      },
      "eventGridTopicEndpoint": {
        "type": "string"
      },
      "eventGridKey": {
        "type": "securestring"
      },
      "fileUris": {
        "type": "string"
      },
      "arguments": {
        "type": "securestring",
        "defaultValue": " "
      }
    },
  
    "variables": {
      "UriFileNamePieces": "[split(parameters('fileUris'), '/')]",
      "firstFileNameString": "[variables('UriFileNamePieces')[sub(length(variables('UriFileNamePieces')), 1)]]",
      "firstFileNameBreakString": "[split(variables('firstFileNameString'), '?')]",
      "firstFileName": "[variables('firstFileNameBreakString')[0]]"
    },
  
  
  
    "resources": [
      {
        "name": "[concat(parameters('vmName'),'/CustomScriptExtension')]",
        "type": "Microsoft.Compute/virtualMachines/extensions",
        "location": "[parameters('location')]",
        "apiVersion": "2015-06-15",
        "properties": {
          "publisher": "Microsoft.Compute",
          "type": "CustomScriptExtension",
          "typeHandlerVersion": "1.7",
          "autoUpgradeMinorVersion": true,
          "settings": {
            "fileUris": [
                "https://raw.githubusercontent.com/zivraf/ScheduledEvents/master/Python/scheduledEventsExtension.py",
                "https://raw.githubusercontent.com/zivraf/ScheduledEvents/master/Python/eventGridHelper.py",
                "https://raw.githubusercontent.com/zivraf/ScheduledEvents/master/Python/scheduledEventsHelper.py",
                "https://raw.githubusercontent.com/zivraf/ScheduledEvents/master/Python/scheduledEventsExtensionConfig.ini",
              ]
          },
            "protectedSettings": {
              "commandToExecute": "[concat ('powershell -ExecutionPolicy Unrestricted -File ', variables('firstFileName'), ' ', parameters('arguments'))]"
            }
          }
        }
    ]
  }